---
import { Badge } from '@astrojs/starlight/components';
import { getAllBits } from '@bits';

const allBits = getAllBits();
const allTags = Array.from(
  new Set(allBits.flatMap((bit) => bit.metadata.tags))
).sort((a, b) => a.localeCompare(b));
---

<div class="not-content space-y-6" data-bits-catalog>
  <div class="flex flex-wrap items-center gap-2">
    <button
      type="button"
      class="catalog-tag-button"
      data-tag=""
      aria-pressed="true"
    >
      <Badge text="All" size="medium" />
    </button>
    {allTags.map((tag) => (
      <button
        type="button"
        class="catalog-tag-button"
        data-tag={tag}
        aria-pressed="false"
      >
        <Badge text={tag} size="medium" />
      </button>
    ))}
  </div>

  <div class="text-xs text-white/50" data-bit-count>
    {allBits.length} bit{allBits.length === 1 ? '' : 's'}
  </div>

  <div class="grid gap-4 sm:grid-cols-2 xl:grid-cols-3">
    {allBits.map((bit) => (
      <div
        class="rounded-xl border border-white/10 bg-[#0C0C0C] p-4"
        data-bit-card
        data-tags={bit.metadata.tags.join('|')}
      >
        <div class="text-base font-semibold text-white">
          {bit.metadata.name}
        </div>
        <p class="mt-2 text-sm text-white/70">
          {bit.metadata.description}
        </p>
        <div class="mt-3 flex flex-wrap gap-2">
          {bit.metadata.tags.map((tag) => (
            <button
              type="button"
              class="catalog-tag-button"
              data-tag={tag}
              aria-pressed="false"
            >
              <Badge text={tag} size="small" />
            </button>
          ))}
        </div>
      </div>
    ))}
  </div>
</div>

<style>
  .catalog-tag-button {
    all: unset;
    cursor: pointer;
    border-radius: 0.25rem;
  }

  .catalog-tag-button:focus-visible {
    outline: 2px solid var(--sl-color-accent);
    outline-offset: 2px;
  }

  /* Active state - Orange/Caution look */
  .catalog-tag-button[aria-pressed="true"] :global(.sl-badge) {
    --sl-color-bg-badge: var(--sl-color-orange-low);
    --sl-color-border-badge: var(--sl-color-orange);
    --sl-color-text-badge: var(--sl-color-white);
  }

  /* Hover state for inactive */
  .catalog-tag-button[aria-pressed="false"]:hover :global(.sl-badge) {
    --sl-color-border-badge: var(--sl-color-gray-3);
  }
</style>

<script>
  const root = document.querySelector('[data-bits-catalog]');
  if (root) {
    const buttons = Array.from(root.querySelectorAll('[data-tag]'));
    const cards = Array.from(root.querySelectorAll('[data-bit-card]'));
    const countEl = root.querySelector('[data-bit-count]');

    // Initialize activeTag from URL parameter
    const params = new URLSearchParams(window.location.search);
    let activeTag = params.get('tag') || null;

    const setButtonState = (button, isActive) => {
      button.setAttribute('aria-pressed', String(isActive));
      // Styling is handled by CSS based on aria-pressed
    };

    const updateUrl = () => {
      const url = new URL(window.location.href);
      if (activeTag) {
        url.searchParams.set('tag', activeTag);
      } else {
        url.searchParams.delete('tag');
      }
      history.replaceState(null, '', url.toString());
    };

    const apply = () => {
      let visible = 0;
      for (const card of cards) {
        const tags = (card.getAttribute('data-tags') || '')
          .split('|')
          .filter(Boolean);
        const match = !activeTag || tags.includes(activeTag);
        card.style.display = match ? '' : 'none';
        if (match) {
          visible += 1;
        }
      }

      if (countEl) {
        countEl.textContent = `${visible} bit${visible === 1 ? '' : 's'}${
          activeTag ? ` tagged with “${activeTag}”` : ''
        }`;
      }

      for (const button of buttons) {
        updateUrl();
        const tag = button.getAttribute('data-tag');
        const tagValue = tag && tag.length > 0 ? tag : null;
        setButtonState(button, tagValue === activeTag);
      }
    };

    for (const button of buttons) {
      button.addEventListener('click', () => {
        const tag = button.getAttribute('data-tag');
        const tagValue = tag && tag.length > 0 ? tag : null;
        activeTag = activeTag === tagValue ? null : tagValue;
        apply();
      });
    }

    apply();
  }
</script>
